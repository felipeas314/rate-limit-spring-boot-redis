services:

  # Redis Cluster - 6 nodes (3 masters + 3 replicas)
  redis-1:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000

  redis-2:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000

  redis-3:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000

  redis-4:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000

  redis-5:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000

  redis-6:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000

  # Init container: waits for all nodes, then forms the cluster
  redis-cluster-init:
    image: redis:7-alpine
    depends_on:
      - redis-1
      - redis-2
      - redis-3
      - redis-4
      - redis-5
      - redis-6
    restart: "no"
    command: >
      sh -c "
        for i in 1 2 3 4 5 6; do
          until redis-cli -h redis-$$i -p 6379 ping | grep -q PONG; do
            echo 'Waiting for redis-'$$i'...'
            sleep 1
          done
        done &&
        redis-cli --cluster create redis-1:6379 redis-2:6379 redis-3:6379 redis-4:6379 redis-5:6379 redis-6:6379 --cluster-replicas 1 --cluster-yes
      "

  # Application instances
  app-1:
    build: .
    environment:
      - REDIS_MODE=cluster
      - REDIS_CLUSTER_ADDRESSES=redis://redis-1:6379,redis://redis-2:6379,redis://redis-3:6379,redis://redis-4:6379,redis://redis-5:6379,redis://redis-6:6379
    depends_on:
      redis-cluster-init:
        condition: service_completed_successfully

  app-2:
    build: .
    environment:
      - REDIS_MODE=cluster
      - REDIS_CLUSTER_ADDRESSES=redis://redis-1:6379,redis://redis-2:6379,redis://redis-3:6379,redis://redis-4:6379,redis://redis-5:6379,redis://redis-6:6379
    depends_on:
      redis-cluster-init:
        condition: service_completed_successfully

  app-3:
    build: .
    environment:
      - REDIS_MODE=cluster
      - REDIS_CLUSTER_ADDRESSES=redis://redis-1:6379,redis://redis-2:6379,redis://redis-3:6379,redis://redis-4:6379,redis://redis-5:6379,redis://redis-6:6379
    depends_on:
      redis-cluster-init:
        condition: service_completed_successfully

  # Nginx load balancer
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app-1
      - app-2
      - app-3
